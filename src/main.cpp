/*ESP Spotify Player
- By Kaustubh
*/
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>
#include <ESP32Encoder.h>
#include <ezButton.h>

// Load Env Variables
#include "secrets.h"

// Load other Files
#include "spotifyClient.cpp"

// Pin Definitions
#define PREV_BTN_PIN 5
#define PLAY_BTN_PIN 18
#define NEXT_BTN_PIN 19
#define ENC_CLK_PIN 4
#define ENC_DT_PIN 2
#define ENC_SW_PIN 15

// OLED Definitions
#define I2C_ADDRESS 0x3c
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1

// Objects
Adafruit_SH1106G display = Adafruit_SH1106G(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
ESP32Encoder encoder;

ezButton prevBtn(PREV_BTN_PIN);
ezButton playBtn(PLAY_BTN_PIN);
ezButton nextBtn(NEXT_BTN_PIN);
ezButton encSwBtn(ENC_SW_PIN);

// Timing variables
unsigned long lastApiRefresh = 0;

// Forward declarations
String truncateString(const String &input, int maxLength);
void handleButtons();
void handleVolumeControl();
bool drawScreen();

// Bitmap Definitions
static const unsigned char PROGMEM no_active_device[] = {0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x07, 0xce, 0x78, 0x03, 0x80, 0x00, 0x41, 0x02, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x04, 0x11, 0x44, 0x04, 0x40, 0x00, 0x40, 0x05, 0x00, 0x01, 0x00, 0x44, 0x01, 0xe0, 0x04, 0x10, 0x44, 0x04, 0x16, 0x39, 0xf3, 0x04, 0x44, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x07, 0x8e, 0x78, 0x03, 0x99, 0x44, 0x41, 0x0e, 0x44, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x04, 0x01, 0x40, 0x00, 0x59, 0x44, 0x41, 0x04, 0x3c, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x04, 0x11, 0x40, 0x04, 0x56, 0x44, 0x51, 0x04, 0x04, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x07, 0xce, 0x40, 0x03, 0x90, 0x38, 0x23, 0x84, 0x44, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x38, 0x01, 0x1f, 0xff, 0x9f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x00, 0x91, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0xf1, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x0f, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x88, 0x62, 0x27, 0x2c, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x0f, 0x08, 0x12, 0x28, 0xb2, 0x00, 0x00, 0x01, 0x00, 0x44, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x08, 0x71, 0xef, 0xa0, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x08, 0x90, 0x28, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x1c, 0x7a, 0x27, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfe, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfc, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x20, 0x00, 0x20, 0x02, 0x08, 0x00, 0x00, 0x3c, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x20, 0x00, 0x50, 0x02, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x27, 0x00, 0x89, 0xcf, 0x98, 0x89, 0xc0, 0x22, 0x72, 0x26, 0x1c, 0x70, 0x00, 0x02, 0xa8, 0x80, 0x8a, 0x22, 0x08, 0x8a, 0x20, 0x22, 0x8a, 0x22, 0x22, 0x88, 0x00, 0x02, 0x68, 0x80, 0xfa, 0x02, 0x08, 0x8b, 0xe0, 0x22, 0xfa, 0x22, 0x20, 0xf8, 0x00, 0x02, 0x28, 0x80, 0x8a, 0x22, 0x88, 0x52, 0x00, 0x22, 0x81, 0x42, 0x22, 0x80, 0x00, 0x02, 0x27, 0x00, 0x89, 0xc1, 0x1c, 0x21, 0xc0, 0x3c, 0x70, 0x87, 0x1c, 0x70, 0x00};
static const unsigned char PROGMEM splash_screen[] = {0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x07, 0xce, 0x78, 0x03, 0x80, 0x00, 0x41, 0x02, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x04, 0x11, 0x44, 0x04, 0x40, 0x00, 0x40, 0x05, 0x00, 0x01, 0x00, 0x44, 0x01, 0xe0, 0x04, 0x10, 0x44, 0x04, 0x16, 0x39, 0xf3, 0x04, 0x44, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x07, 0x8e, 0x78, 0x03, 0x99, 0x44, 0x41, 0x0e, 0x44, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x04, 0x01, 0x40, 0x00, 0x59, 0x44, 0x41, 0x04, 0x3c, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x04, 0x11, 0x40, 0x04, 0x56, 0x44, 0x51, 0x04, 0x04, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x07, 0xce, 0x40, 0x03, 0x90, 0x38, 0x23, 0x84, 0x44, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x38, 0x01, 0x1f, 0xff, 0x9f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x00, 0x91, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0xf1, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x0f, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x88, 0x62, 0x27, 0x2c, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x0f, 0x08, 0x12, 0x28, 0xb2, 0x00, 0x00, 0x01, 0x00, 0x44, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x08, 0x71, 0xef, 0xa0, 0x00, 0x00, 0x01, 0x00, 0x7c, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x08, 0x90, 0x28, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x08, 0x1c, 0x7a, 0x27, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfe, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfc, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x02, 0x20, 0x00, 0x00, 0x80, 0x20, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x80, 0x02, 0x40, 0x00, 0x00, 0x80, 0x20, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xa2, 0x02, 0x86, 0x22, 0x7b, 0xe8, 0xac, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x22, 0x03, 0x01, 0x22, 0x80, 0x88, 0xb2, 0xc8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x9e, 0x02, 0x87, 0x22, 0x70, 0x88, 0xa2, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x82, 0x02, 0x49, 0x26, 0x08, 0xa9, 0xb2, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x22, 0x02, 0x27, 0x9a, 0xf0, 0x46, 0xac, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
static const unsigned char PROGMEM configuring[] = {0x80, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc1, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x22, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x0c, 0x07, 0x00, 0x00, 0x42, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x0a, 0xb4, 0x08, 0x80, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x48, 0x08, 0x1c, 0xb0, 0x86, 0x1c, 0x8a, 0xc6, 0x2c, 0x70, 0x00, 0x00, 0x05, 0xf0, 0x08, 0x22, 0xc9, 0xc2, 0x26, 0x8b, 0x22, 0x32, 0x98, 0x00, 0x00, 0x0b, 0x00, 0x08, 0x22, 0x88, 0x82, 0x26, 0x8a, 0x02, 0x22, 0x98, 0x00, 0x00, 0x14, 0xe0, 0x08, 0xa2, 0x88, 0x82, 0x1a, 0x9a, 0x02, 0x22, 0x68, 0xc3, 0x0c, 0x29, 0xb0, 0x07, 0x1c, 0x88, 0x87, 0x02, 0x6a, 0x07, 0x22, 0x08, 0xc3, 0x0c, 0x50, 0xd8, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0xa0, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

bool drawScreen()
{
  display.clearDisplay();

  if (!spotifyConnection.getStatus())
  {
    // Show the no active device screen
    display.drawBitmap(9, 8, no_active_device, 112, 49, 1);
    display.display();
    return true;
  }

  // Display content for active device
  display.setTextColor(SH110X_WHITE);
  display.setTextSize(1);

  // Truncate long strings
  String songName = truncateString(spotifyConnection.getCurrentSong().song, 20);
  String artistName = truncateString(spotifyConnection.getCurrentSong().artist, 20);

  // Display song info
  display.setCursor(0, 0);
  display.print(songName);

  display.setCursor(0, 15);
  display.print(artistName);

  // Draw progress bar
  int barY = 30;
  int barHeight = 8;
  int barWidth = map(spotifyConnection.getCurrentPositionMs(), 0, spotifyConnection.getCurrentSong().durationMs, 0, SCREEN_WIDTH);

  display.drawRect(0, barY, SCREEN_WIDTH, barHeight, SH110X_WHITE);
  display.fillRect(0, barY, barWidth, barHeight, SH110X_WHITE);

  // Display play/pause state
  display.setCursor(45, 55);
  display.print(spotifyConnection.getStatus() ? "Playing" : "Paused");

  // Display volume
  display.setCursor(110, 55);
  display.print(spotifyConnection.volCtrl ? String(spotifyConnection.currVol) : "N/A");

  display.display();
  return true;
}

// Helper function to truncate strings
String truncateString(const String &input, int maxLength)
{
  if (input.length() <= maxLength)
    return input;
  return input.substring(0, maxLength - 3) + "...";
}

// Button handler function
void handleButtons()
{
  if (prevBtn.isPressed())
  {
    Serial.println("Previous button pressed");
    spotifyConnection.skipBack();
    spotifyConnection.getTrackInfo();
  }

  else if (playBtn.isPressed())
  {
    Serial.println("Play button pressed");
    spotifyConnection.togglePlay();
  }

  else if (nextBtn.isPressed())
  {
    Serial.println("Next button pressed");
    spotifyConnection.skipForward();
    spotifyConnection.getTrackInfo();
  }

  if (encSwBtn.isPressed())
  {
    Serial.println("Encoder switch pressed");
    spotifyConnection.togglePlay();
  }

  prevBtn.loop();
  playBtn.loop();
  nextBtn.loop();
  encSwBtn.loop();
}

// Volume control handler
void handleVolumeControl()
{
  if (spotifyConnection.volCtrl)
  {
    int newVolume = encoder.getCount() * 5;
    // Only update if volume change exceeds threshold
    if (abs(newVolume - spotifyConnection.currVol) > VOLUME_UPDATE_THRESHOLD)
    {
      spotifyConnection.adjustVolume(newVolume);
    }
  }
}

// Global flag for server state
bool serverOn = true;

void setup()
{
  // Initialize serial communication
  Serial.begin(9600);
  Serial.println("Starting ESP32 Spotify Player");

  // Initialize display
  delay(250); // Wait for OLED to initialize
  display.begin(I2C_ADDRESS, true);

  // Show splash screen
  display.clearDisplay();
  display.drawBitmap(9, 8, splash_screen, 112, 51, 1);
  display.display();
  delay(700);

  // Set up button pins
  pinMode(PLAY_BTN_PIN, INPUT_PULLUP);
  pinMode(PREV_BTN_PIN, INPUT_PULLUP);
  pinMode(NEXT_BTN_PIN, INPUT_PULLUP);
  pinMode(ENC_SW_PIN, INPUT_PULLUP);

  // Set up rotary encoder
  encoder.attachHalfQuad(ENC_DT_PIN, ENC_CLK_PIN);

  spotifyConnection.initialize();
  encoder.setCount(spotifyConnection.getCurrentVolume() / 5);

  // Show configuration screen
  display.clearDisplay();
  display.setTextColor(1);
  display.setTextWrap(false);
  display.setCursor(5, 38);
  display.print("ESP IP:" + WiFi.localIP().toString());
  display.drawBitmap(14, 15, configuring, 102, 15, 1);
  display.display();
}

void loop()
{
  unsigned long currentMillis = millis();

  // If not authenticated, handle web server requests
  if (!spotifyConnection.accessTokenSet)
  {
    secureServer->loop();
    return;
  }

  // Close server after authentication
  if (serverOn)
  {
    secureServer->stop();
    serverOn = false;
  }

  // Refresh access token if needed
  if ((currentMillis - spotifyConnection.tokenStartTime) / 1000 > spotifyConnection.tokenExpireTime - 60)
  {
    Serial.println("Refreshing token");
    if (spotifyConnection.refreshAuth())
    {
      Serial.println("Token refreshed successfully");
    }
  }

  // Update track info periodically
  if (currentMillis - lastApiRefresh > API_REFRESH_INTERVAL)
  {
    spotifyConnection.getTrackInfo();
    lastApiRefresh = currentMillis;
  }

  // Handle user input
  handleButtons();

  // Handle volume control
  handleVolumeControl();
}

// Web server handlers
void handleRoot(HTTPRequest *req, HTTPResponse *res)
{
  Serial.println("Handling root request");

  // Static buffer (safer than stack allocation)
  static char page[8192];

  // Generate the page
  if (snprintf(page, sizeof(page), mainPage, CLIENT_ID, REDIRECT_URI) < 0)
  {
    res->setStatusCode(500);
    res->setStatusText("Internal Server Error");
    res->println("Failed to generate page");
    return;
  }

  // Set headers and send response
  res->setHeader("Content-Type", "text/html");
  res->println(page);
}

void handleCallbackPage(HTTPRequest *req, HTTPResponse *res)
{
  // Debug logging
  Serial.println("=== CALLBACK HEADERS ===");
  Serial.print("Request line: ");
  Serial.println(req->getRequestString().c_str());

  // Get the "code" parameter from query string
  std::string code;
  bool hasCode = req->getParams()->getQueryParameter("code", code);

  if (!spotifyConnection.accessTokenSet)
  {
    if (code.empty())
    {
      static char page[8192];
      if (snprintf(page, sizeof(page), errorPage, CLIENT_ID, REDIRECT_URI) < 0)
      {
        res->setStatusCode(500);
        res->setStatusText("Internal Server Error");
        res->println("Error page generation failed");
        return;
      }
      res->setHeader("Content-Type", "text/html");
      res->println(page);
    }
    else
    { // Convert std::string to String
      String codeStr = String(code.c_str());
      if (spotifyConnection.getUserCode(codeStr))
      {
        res->setHeader("Content-Type", "text/plain");
        res->print("Spotify setup complete. Refresh in: ");
        res->print(String(spotifyConnection.tokenExpireTime));
      }
      else
      {
        static char page[800];
        if (snprintf(page, sizeof(page), errorPage, CLIENT_ID, REDIRECT_URI) < 0)
        {
          res->setStatusCode(500);
          res->setStatusText("Internal Server Error");
          res->println("Error page generation failed");
          return;
        }
        res->setHeader("Content-Type", "text/html");
        res->println(page);
      }
    }
  }
  else
  {
    res->setHeader("Content-Type", "text/plain");
    res->println("Already authenticated");
  }
}

void handle404(HTTPRequest *req, HTTPResponse *res)
{
  // Discard request body if any
  req->discardRequestBody();

  // Set response status
  res->setStatusCode(404);
  res->setStatusText("Not Found");

  // Set content type
  res->setHeader("Content-Type", "text/html");

  // Write 404 page
  res->println("<!DOCTYPE html>");
  res->println("<html>");
  res->println("<head><title>Not Found</title></head>");
  res->println("<body><h1>404 Not Found</h1><p>The requested resource was not found on this server.</p></body>");
  res->println("</html>");
}